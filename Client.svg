<?xml version="1.0" encoding="UTF-8"?>
<svg width="900" height="1200" xmlns="http://www.w3.org/2000/svg">
    <!-- Start -->
    <rect x="400" y="20" width="100" height="40" rx="10" fill="#4CAF50" stroke="black"/>
    <text x="450" y="45" text-anchor="middle" fill="white">Start</text>

    <!-- Initialize Parameters -->
    <rect x="350" y="90" width="200" height="80" rx="10" fill="#2196F3" stroke="black"/>
    <text x="450" y="120" text-anchor="middle" fill="white">Initialize Parameters</text>
    <text x="450" y="135" text-anchor="middle" fill="white" font-size="10">timeout, connIaTime</text>
    <text x="450" y="150" text-anchor="middle" fill="white" font-size="10">queryIaTime, numQuery</text>
    <text x="450" y="165" text-anchor="middle" fill="white" font-size="10">Set addresses</text>

    <!-- Connection Setup -->
    <rect x="350" y="200" width="200" height="100" rx="10" fill="#9C27B0" stroke="black"/>
    <text x="450" y="230" text-anchor="middle" fill="white">Connection Setup</text>
    <text x="450" y="245" text-anchor="middle" fill="white" font-size="10">1. Send DYNA_CONN_REQ</text>
    <text x="450" y="260" text-anchor="middle" fill="white" font-size="10">2. Wait for DYNA_CONN_ACK</text>
    <text x="450" y="275" text-anchor="middle" fill="white" font-size="10">3. Store serverProcId</text>

    <!-- Timeout Check 1 -->
    <path d="M350,330 L450,380 L550,330 L450,280 Z" fill="#FF5722" stroke="black"/>
    <text x="450" y="340" text-anchor="middle">Timeout?</text>

    <!-- Query Loop -->
    <rect x="350" y="400" width="200" height="120" rx="10" fill="#00BCD4" stroke="black"/>
    <text x="450" y="430" text-anchor="middle" fill="white">Query Loop</text>
    <text x="450" y="445" text-anchor="middle" fill="white" font-size="10">1. Send DATA(query)</text>
    <text x="450" y="460" text-anchor="middle" fill="white" font-size="10">2. Wait for DATA(result)</text>
    <text x="450" y="475" text-anchor="middle" fill="white" font-size="10">3. Process response</text>
    <text x="450" y="490" text-anchor="middle" fill="white" font-size="10">4. Wait queryIaTime</text>

    <!-- Timeout Check 2 -->
    <path d="M350,550 L450,600 L550,550 L450,500 Z" fill="#FF5722" stroke="black"/>
    <text x="450" y="560" text-anchor="middle">Timeout?</text>

    <!-- Disconnect -->
    <rect x="350" y="620" width="200" height="100" rx="10" fill="#795548" stroke="black"/>
    <text x="450" y="650" text-anchor="middle" fill="white">Disconnect</text>
    <text x="450" y="665" text-anchor="middle" fill="white" font-size="10">1. Send DYNA_DISC_REQ</text>
    <text x="450" y="680" text-anchor="middle" fill="white" font-size="10">2. Wait for DYNA_DISC_ACK</text>
    <text x="450" y="695" text-anchor="middle" fill="white" font-size="10">3. Clean up</text>

    <!-- Timeout Check 3 -->
    <path d="M350,750 L450,800 L550,750 L450,700 Z" fill="#FF5722" stroke="black"/>
    <text x="450" y="760" text-anchor="middle">Timeout?</text>

    <!-- Error Handling -->
    <rect x="600" y="450" width="200" height="80" rx="10" fill="#F44336" stroke="black"/>
    <text x="700" y="480" text-anchor="middle" fill="white">Error Handling</text>
    <text x="700" y="495" text-anchor="middle" fill="white" font-size="10">Connection Broken</text>
    <text x="700" y="510" text-anchor="middle" fill="white" font-size="10">Show Error Message</text>

    <!-- Continue -->
    <rect x="350" y="820" width="200" height="60" rx="10" fill="#4CAF50" stroke="black"/>
    <text x="450" y="855" text-anchor="middle" fill="white">Continue Next Cycle</text>

    <!-- Arrows -->
    <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
            <polygon points="0 0, 10 3.5, 0 7" fill="black"/>
        </marker>
    </defs>

    <!-- Connect all components with arrows -->
    <line x1="450" y1="60" x2="450" y2="90" stroke="black" marker-end="url(#arrowhead)"/>
    <line x1="450" y1="170" x2="450" y2="200" stroke="black" marker-end="url(#arrowhead)"/>
    <line x1="450" y1="300" x2="450" y2="330" stroke="black" marker-end="url(#arrowhead)"/>
    <line x1="450" y1="380" x2="450" y2="400" stroke="black" marker-end="url(#arrowhead)"/>
    <line x1="450" y1="520" x2="450" y2="550" stroke="black" marker-end="url(#arrowhead)"/>
    <line x1="450" y1="600" x2="450" y2="620" stroke="black" marker-end="url(#arrowhead)"/>
    <line x1="450" y1="720" x2="450" y2="750" stroke="black" marker-end="url(#arrowhead)"/>
    <line x1="450" y1="800" x2="450" y2="820" stroke="black" marker-end="url(#arrowhead)"/>
    
    <!-- Error paths -->
    <line x1="550" y1="330" x2="700" y2="450" stroke="black" marker-end="url(#arrowhead)"/>
    <line x1="550" y1="550" x2="600" y2="490" stroke="black" marker-end="url(#arrowhead)"/>
    <line x1="550" y1="750" x2="700" y2="530" stroke="black" marker-end="url(#arrowhead)"/>
    
    <!-- Return to start -->
    <line x1="450" y1="880" x2="350" y2="880" stroke="black"/>
    <line x1="350" y1="880" x2="350" y2="150" stroke="black"/>
    <line x1="350" y1="150" x2="350" y2="90" stroke="black" marker-end="url(#arrowhead)"/>

    <!-- Labels -->
    <text x="550" y="340" text-anchor="middle">Yes</text>
    <text x="450" y="340" text-anchor="middle">No</text>
    <text x="550" y="560" text-anchor="middle">Yes</text>
    <text x="450" y="560" text-anchor="middle">No</text>
    <text x="550" y="760" text-anchor="middle">Yes</text>
    <text x="450" y="760" text-anchor="middle">No</text>
</svg>